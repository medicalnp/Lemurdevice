<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Lemur</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200;0,300;0,400;0,600;0,700;0,800;0,900;1,200;1,300;1,400;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="icons.css">
    <link rel="stylesheet" href="style.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.2.1/dist/chart.min.js"></script>
      
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>
  
  
<script type="text/javascript">
        // More API functions here:
        // https://github.com/googlecreativelab/teachablemachine-community/tree/master/libraries/pose

        // the link to your model provided by Teachable Machine export panel
        const URL = "https://teachablemachine.withgoogle.com/models/1BYCW0Yh1/";
        let model, webcam, ctx, labelContainer, maxPredictions, labelCounter, counter, myChart;
        
        //create an array with the number of classes - in this case 3 different classes filled with all 0 to start
        let timer = new Array(3).fill(0);

        async function init() {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            // load the model and metadata
            // Refer to tmImage.loadFromFiles() in the API to support files from a file picker
            // Note: the pose library adds a tmPose object to your window (window.tmPose)
            model = await tmPose.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();

            // Convenience function to setup a webcam
            const size = 200;
            const flip = true; // whether to flip the webcam
            webcam = new tmPose.Webcam(size, size, flip); // width, height, flip
            await webcam.setup(); // request access to the webcam
            await webcam.play();
            window.requestAnimationFrame(loop);

            // append/get elements to the DOM
            const canvas = document.getElementById("canvas");
            canvas.width = size; canvas.height = size;
            ctx = canvas.getContext("2d");
            labelContainer = document.getElementById("label-container");

            // *****Add a variable for labelCounter and assign it to label-counter div
            labelCounter = document.getElementById("label-counter")

            for (let i = 0; i < maxPredictions; i++) { // and class labels
                labelContainer.appendChild(document.createElement("div"));

            // ******Assign labelCounter.append to add the data you want
                labelCounter.appendChild(document.createElement("div"));

            }
        }

        async function loop(timestamp) {
            webcam.update(); // update the webcam frame
            await predict();
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            // Prediction #1: run input through posenet
            // estimatePose can take in an image, video or canvas html element
            const { pose, posenetOutput } = await model.estimatePose(webcam.canvas);
            // Prediction 2: run input through teachable machine classification model
            const prediction = await model.predict(posenetOutput);
            window.bar2 = prediction;

            for (let i = 0; i < maxPredictions; i++) {
                const classPrediction =
                    prediction[i].className + ": " + prediction[i].probability.toFixed(2);
                labelContainer.childNodes[i].innerHTML = classPrediction


            }

            // finally draw the poses
            drawPose(pose);
        }

//////////////

setInterval(count,1000);
function count(){
           
            for (let i = 0; i < maxPredictions; i++) {
                   
                //*** add variable for counter label
                const counter = 
                    "You have been in position: " + window.bar2[i].className + " for " + timer[i] + " seconds duration";
                labelCounter.childNodes[i].innerHTML = counter;


                //** add an if statement that will hopefully work
                if (window.bar2[i].probability.toFixed(2) > 0.50) {
                    timer[i] += 1;
                   }
               

            }

        }


var timingBelt = setInterval(drawGraph,5000);
function drawGraph() {

const xValues = [window.bar2[0].className, window.bar2[1].className, window.bar2[2].className];
const yValues = [timer[0], timer[1], timer[2]];
const barColors = ["red", "green","blue","orange","brown"];

if(window.myChart instanceof Chart)
{
    window.myChart.destroy();
}


window.myChart = new Chart("myChart", {
  type: "bar",
  data: {
    labels: xValues,
    datasets: [{
      backgroundColor: barColors,
      data: yValues
    }]
  },
  options: {
    legend: {display: false},
    title: {
      display: false,
      text: "Duration of each classification"
    },
    scales: {
            y: {
                beginAtZero: true}
            }
      }
    });
}



function reset() { 
        timer[0] = 0;
        timer[1] = 0;
        timer[2] = 0;
        timer[3] = 0;
       window.myChart.destroy();
       drawGraph();
    
}

function stop() {
    window.location.reload(true);
    clearInterval(timingBelt);
}
/////////





        function drawPose(pose) {
            if (webcam.canvas) {
                ctx.drawImage(webcam.canvas, 0, 0);
                // draw the keypoints and skeleton
                if (pose) {
                    const minPartConfidence = 0.5;
                    tmPose.drawKeypoints(pose.keypoints, minPartConfidence, ctx);
                    tmPose.drawSkeleton(pose.keypoints, minPartConfidence, ctx);
                }
            }
        }
    </script>
  
  
  
</head>
<body>
    <div class="dashboard"><!-- Dashboard -->
        <section class="navigation"><!-- Navigation -->
            <img src="assets/img/logo-thumbnail.png" alt="Lemur Logo" class="logo">

            <div>
                <span class="material-icons-outlined"> dashboard </span>
                <span class="material-icons-outlined">settings_suggest</span>
            </div>

            

        </section><!-- Navigation End -->

        <section class="main"><!-- Main -->
            <div class="search"><!-- Search -->
                <form action="">
                    <input type="text" name="search" id="search" placeholder="Search Here">
                    <span class="material-icons-outlined"> search </span>
                </form>

                <div class="notification">
                    <span class="material-icons-outlined"> notifications </span>
                </div>
            </div><!-- Search End -->

            <div class="title">
                <h1>Monitor</h1>
                <form action="#">
                    <label for="projects">Sort By</label>
                    <select name="projects" id="projects">
                        <option value="recent">Wards</option>
                        <option value="finished">Activity</option>
                    </select>
                </form>
            </div>

            <div class="project_list"><!-- Project List -->

                <div class="project"><!-- Project1 -->
                    <div class="category category_color1"></div>
                    <h2>Ward 17 A4</h2>
                    <p>Please press start and wait for model to load</p>
                  <div class="camera"><!--camera feed 1-->
                   <button type="button" onclick="init()">Start</button>
                    <div><canvas id="canvas"></canvas></div>
                    <div id="label-container"></div>
                    <!--added a div input the label-->
    
    
    <div =id="buttons">
        <button id="stop" onclick="stop()">Stop</button>
        <button id="reset" onclick="reset()">Reset</button>


                   <!-- <ul class="activity">
                      <li>Coming soon banner</li>
                    </ul>
-->

                    <!--<div class="meta">
                        <div class="contributors">
                            <img src="assets/img/1.jpg" alt="">
                            <img src="assets/img/2.jpg" alt="" class="stack">
                            <img src="assets/img/3.jpg" alt="" class="stack">
                        </div>
                        <span class="material-icons-outlined">more_vert</span>
                    </div> -->
                </div><!-- Project1 End -->


            </div><!-- Project List End -->

        </section><!-- Main End -->

        <section class="secondary"><!-- Secondary -->
            <div class="chart">
                <h2>Results</h2>
                <canvas id="myChart" width="400" height="400"></canvas>
              <div id="label-counter"></div>

                <!--<div class="complete">
                    <h3>3 Completed</h3>
                    <p>from 5 projects</p>
                </div> -->
            </div>

          
            <!-- 
            <div class="recent_project"><!-- Recent Project ++>
                <div class="listing">
                    <div class="title">
                        <div class="category category_color1"></div>
                        <h2>Layouting</h2>
                        <p>by Chidozie Kachukwu</p>
                    </div>
                    <span class="material-icons-outlined">more_vert</span>
                </div>
                <div class="listing">
                    <div class="title">
                        <div class="category category_color2"></div>
                        <h2>Photoshoot</h2>
                        <p>by Musa Ismail</p>
                    </div>
                    <span class="material-icons-outlined">more_vert</span>
                </div>
                <div class="listing">
                    <div class="title">
                        <div class="category category_color3"></div>
                        <h2>Branding</h2>
                        <p>by Ezekiel Arowolo</p>
                    </div>
                    <span class="material-icons-outlined">more_vert</span>
                </div>
                <div class="listing">
                    <div class="title">
                        <div class="category category_color4"></div>
                        <h2>Graphics Design</h2>
                        <p>by Matthew Kelechi</p>
                    </div>
                    <span class="material-icons-outlined">more_vert</span>
                </div>
            </div><!-- Recent Project End ++>
            -->
      

        </section><!-- Secondary End -->

    </div><!-- Dashboard End-->
    
  
</body>
</html>
